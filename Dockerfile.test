FROM golang:1.23-alpine

# Install CIFS utilities and tools needed for SMB mounting
RUN apk add --no-cache \
    cifs-utils \
    samba-client \
    bash \
    fuse \
    netcat-openbsd \
    && mkdir -p /mnt/smb-test

WORKDIR /app

# Copy go mod files first for better caching
COPY go.mod go.sum* ./
RUN go mod download

# Copy source code
COPY . .

# Create directory for test results
RUN mkdir -p /app/test-results

# Script to mount SMB share and run tests
COPY <<'EOF' /entrypoint.sh
#!/bin/bash
set -e

echo "=== Starting SMB Integration Tests ==="
echo "SMB Host: ${SMB_HOST}"
echo "SMB Share: ${SMB_SHARE}"
echo "Mount Point: ${SMB_MOUNT}"

# Wait for Samba to be ready (max 90 seconds)
echo "Waiting for Samba server..."
echo "SMB Host: ${SMB_HOST}"
echo "SMB User: ${SMB_USER}"

# Give Samba extra time to initialize user accounts
echo "Waiting 15 seconds for Samba to fully initialize..."
sleep 15

RETRIES=30
COUNT=0
until smbclient -L "${SMB_HOST}" -U "${SMB_USER}%${SMB_PASS}" > /dev/null 2>&1; do
    COUNT=$((COUNT + 1))
    if [ $COUNT -ge $RETRIES ]; then
        echo "✗ Timed out waiting for Samba server after ${RETRIES} attempts"
        echo "Attempting to connect to: ${SMB_HOST}"
        echo "Debugging information:"
        ping -c 3 "${SMB_HOST}" || true
        echo ""
        echo "Checking if port 445 is accessible:"
        nc -zv "${SMB_HOST}" 445 || true
        echo ""
        echo "Trying smbclient with verbose output:"
        smbclient -L "${SMB_HOST}" -U "${SMB_USER}%${SMB_PASS}" -d 3 || true
        exit 1
    fi
    echo "Waiting for Samba server to be ready... (${COUNT}/${RETRIES})"
    sleep 2
done
echo "✓ Samba server is ready!"

# Create mount point
mkdir -p "${SMB_MOUNT}"

# Mount the SMB share
echo "Mounting SMB share..."
mount -t cifs "//${SMB_HOST}/${SMB_SHARE}" "${SMB_MOUNT}" \
    -o "user=${SMB_USER},password=${SMB_PASS},vers=3.0,uid=$(id -u),gid=$(id -g)"

# Verify mount
if mountpoint -q "${SMB_MOUNT}"; then
    echo "✓ SMB share mounted successfully at ${SMB_MOUNT}"
    ls -la "${SMB_MOUNT}"
else
    echo "✗ Failed to mount SMB share"
    exit 1
fi

# Run integration tests
echo ""
echo "=== Running Integration Tests ==="
go test -v -tags=integration ./tests/integration/... -count=1 | tee /app/test-results/integration-tests.log

TEST_EXIT_CODE=${PIPESTATUS[0]}

# Unmount before exit
echo ""
echo "=== Cleaning Up ==="
umount "${SMB_MOUNT}" || true

exit ${TEST_EXIT_CODE}
EOF

RUN chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]
